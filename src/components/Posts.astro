---
import { SOCIAL_LINKS } from "../consts";
import { getCollection } from "astro:content";
import { getUniqueTags, getPostsByTag } from "../utils";
import { generateURL, decodeTag } from "../utils";

const posts = (await getCollection("blog", post => !post.data.hide)).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
const tags = getUniqueTags(posts);
---

<div>
    <div class="topbar">
        <ul class="inline-container">
            <li>
                <a href="javascript:void(0)" class="filter-btn" data-tag="">
                    {"all".toUpperCase()}
                </a>
            </li>
            {
                tags.map(tag => (
                  <li>
                    <a href="javascript:void(0)" class="filter-btn" data-tag={tag}>
                    {decodeTag(tag).toUpperCase()}
                    </a>
                  </li>
                ))
            }

            {
                Object.entries(SOCIAL_LINKS).map(([key, value]) => {
                  if (!value) return null;
                  return (
                    <li>
                      <a
                        href={value}
                        rel="noopener noreferrer"
                        target="_blank"
                        aria-label={`Link to ${key}`}
                        title={`Link to ${key}`}
                      >
                        {key.toUpperCase()}
                      </a>
                    </li>
                  );
                })
              }
            <li>
                <a href={generateURL(`/about/`)}>
                  ABOUT
                </a>
            </li>
            <li id="theme-btn" aria-label="auto" aria-live="polite" role="button">
                <a id="theme-text" class="theme-text">
                    LIGHT
                </a>
            </li>
        </ul>    
    </div>

    <div class="scrollposts">
        <!-- Post container -->
        <ul class="blog-posts">
          {posts.map(post => (
            <li class="post" data-tags={post.data.tags.join(" ")}>
              <a
                href={generateURL(`/blog/${post.id}/`)}
                data-img={post.data.preview_image}
                data-desc={post.data.description}
                data-astro-reload
              >
                {post.data.title.toUpperCase()}
              </a>
            </li>
          ))}
        </ul>
    </div>
  </div>

<div id="hover-preview-container">
  <img id="hover-preview" class="preview-img" />
  <div id="hover-preview-text" class="preview-text"></div>
</div>

<!-- <img id="hover-preview" class="preview-img" /> -->

<script is:inline>
function attachHoverPreview() {
  const container = document.getElementById('hover-preview-container');
  const img = document.getElementById('hover-preview');
  const text = document.getElementById('hover-preview-text');

  if ('ontouchstart' in window || navigator.maxTouchPoints > 0) return;

  document.querySelectorAll('.blog-posts a').forEach(link => {
    // Clear old listeners if re-attaching
    link.onmousemove = null;
    link.onmouseleave = null;

    link.addEventListener('mousemove', e => {
      const src = link.dataset.img;
      const desc = link.dataset.desc;
      if (!src) return;

      img.src = src;
      text.textContent = desc || '';

      container.style.left = (e.clientX) + 'px';
      container.style.top = (e.clientY) + 'px';
      container.style.opacity = 1;
    });

    link.addEventListener('mouseleave', () => {
      container.style.opacity = 0;
    });
  });
}

// Initial attachment
attachHoverPreview();

// Reattach after Astro swaps the page content
document.addEventListener('astro:after-swap', attachHoverPreview);
</script>

<style>
  #hover-preview-container {
    max-width: 30vw;
    position: fixed;
    pointer-events: none;
    opacity: 0;
    z-index: 9997;
    transition: opacity 1s ease;
    transform: translate(20px, 20px);
    border: dashed 1px;
  }
  .preview-img {
    pointer-events: none;
    transition: opacity 1s;
    opacity: 1;
    z-index: 9998;
  }
  .preview-text {
    font-size: 1.2rem;
    max-width: 100%;
    margin: 5px;
    z-index: 9999;
    white-space: normal;
    overflow-wrap: break-word;
  }
</style>

<script>
  // Function to filter posts based on selected tag
  function filterContent(tag) {
    const posts = document.querySelectorAll(".post");

    posts.forEach(post => {
      const postTags = post.dataset.tags.split(" ");
      post.style.display = (!tag || postTags.includes(tag)) ? "block" : "none";
    });
  }

  // Reads URL param and applies filter
  function applyURLFilter() {
    const params = new URLSearchParams(window.location.search);
    const tag = params.get("tag");
    filterContent(tag); // always run, even if empty
  }

  // Filter button click → update URL
  function attachFilterButtons() {
    document.querySelectorAll('.filter-btn').forEach(button => {
      button.onclick = null;
      button.addEventListener('click', function() {
        const tag = this.getAttribute('data-tag');
        const params = new URLSearchParams(window.location.search);

        if (tag) params.set("tag", tag);
        else params.delete("tag");

        history.pushState({}, "", `?${params.toString()}`);
        filterContent(tag);
      });
    });
  }

  // Theme toggle (unchanged)
  function attachThemeToggle() {
    const themeBtn = document.getElementById('theme-btn');
    const themeText = document.getElementById('theme-text');
    if (!themeBtn || !themeText) return;

    themeText.textContent = document.body.classList.contains('dark-mode') ? 'DARK' : 'LIGHT';
    themeBtn.onclick = null;

    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      themeText.textContent = document.body.classList.contains('dark-mode') ? 'DARK' : 'LIGHT';
    });
  }

  /* ------------------ INIT ------------------ */
  attachFilterButtons();
  attachThemeToggle();
  applyURLFilter();                // ⭐ <-- this was missing

  document.addEventListener('astro:after-swap', () => {
    attachFilterButtons();
    attachThemeToggle();
    applyURLFilter();              // ⭐ <-- now URL param works after nav too
  });
</script>

<style>

  ul {
      margin: 0;
      padding: 0;
      list-style-type: none;
  }

  .inline-container > * {
      margin: 0;
  }

  .inline-container {
    width:100%;
    max-width: 600px;
    display: flex;
    flex-wrap: wrap; /* Allows wrapping */
    justify-content: center; /* Center items */
    align-items: center;
    gap: 10px; /* Keeps consistent spacing */
    padding: 10px;
    text-align: center;
}

.inline-container li {
    display: inline-block; /* Prevents stretching */
    white-space: nowrap; /* Prevents text wrapping inside */
}

.topbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    max-width: 100vw;
    margin-bottom: 20px;
    border-bottom: dashed;
    border-bottom-width: 1px;
    padding: 10px 0;
    display:flex;
    justify-content: center;
    font-size: 1.2rem;
}

  .scrollposts{
    max-width: 720px;
    width: 100%;
    padding-top: 180px;
    overflow-y: scroll; /* Allow vertical scrolling */
    font-size: 1.2rem;
  }

@media (max-width: 60em) {
  .topbar {
    font-size: 0.9rem;
  }
  .scrollposts {
    font-size: 0.9rem;
  }
  .preview-text {
    font-size: 0.9rem;
  }
}

  .blog-posts {
  }

  .blog-posts > *{
      padding-left: 20px;
      padding-right: 20px;
      padding-top: 20px;
      padding-bottom: 25px;
  }

  .post:hover {
      font-weight: bold;
  }

  a {
      color: var(--link-color);
      cursor: pointer;
      text-decoration: none;
  }

  a {
      text-underline-offset: 4px;
  }

  a:hover {
      text-decoration: underline;
      text-decoration-style: dashed;
  }
</style>
